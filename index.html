<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Takt — タスク管理 + カレンダー">
  <title>Takt</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <div class="safe-area-top"></div>

  <!-- ① ヘッダー -->
  <header class="header">
    <div class="header-left">
      <h1 class="header-date" id="headerDate">Hello</h1>
    </div>
    <div class="header-center">
      <div class="header-nav">
        <button class="nav-btn" id="prevDayBtn" aria-label="前の日">
          <svg viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button class="today-btn" id="todayBtn">今日</button>
        <button class="nav-btn" id="nextDayBtn" aria-label="次の日">
          <svg viewBox="0 0 24 24">
            <polyline points="9 6 15 12 9 18"></polyline>
          </svg>
        </button>
      </div>
    </div>
    <div class="header-right">
      <button class="settings-btn" id="settingsBtn" aria-label="設定">
        <svg viewBox="0 0 512 512">
          <path
            d="M499.453,210.004l-55.851-2.58c-5.102-0.23-9.608-3.395-11.546-8.103l-11.508-27.695c-1.937-4.728-0.997-10.145,2.455-13.914l37.668-41.332c4.718-5.188,4.546-13.205-0.421-18.182l-46.434-46.443c-4.986-4.967-13.003-5.159-18.2-0.412l-41.312,37.668c-3.778,3.443-9.206,4.402-13.924,2.436l-27.694-11.488c-4.718-1.946-7.864-6.454-8.094-11.565l-2.589-55.831C301.675,5.534,295.883,0,288.864,0h-65.708c-7.02,0-12.831,5.534-13.156,12.562l-2.571,55.831c-0.23,5.111-3.376,9.618-8.094,11.565L171.64,91.447c-4.737,1.966-10.165,1.007-13.924-2.436l-41.331-37.668c-5.198-4.746-13.215-4.564-18.201,0.412L51.769,98.198c-4.986,4.977-5.158,12.994-0.422,18.182l37.668,41.332c3.452,3.769,4.373,9.186,2.416,13.914l-11.469,27.695c-1.956,4.708-6.444,7.873-11.564,8.103l-55.832,2.58c-7.019,0.316-12.562,6.118-12.562,13.147v65.699c0,7.019,5.543,12.83,12.562,13.148l55.832,2.579c5.12,0.229,9.608,3.394,11.564,8.103l11.469,27.694c1.957,4.728,1.036,10.146-2.416,13.914l-37.668,41.313c-4.756,5.217-4.564,13.224,0.403,18.201l46.471,46.443c4.967,4.977,12.965,5.15,18.182,0.422l41.312-37.677c3.759-3.443,9.207-4.392,13.924-2.435l27.694,11.478c4.719,1.956,7.864,6.464,8.094,11.575l2.571,55.831c0.325,7.02,6.136,12.562,13.156,12.562h65.708c7.02,0,12.812-5.542,13.138-12.562l2.589-55.831c0.23-5.111,3.376-9.619,8.094-11.575l27.694-11.478c4.718-1.957,10.146-1.008,13.924,2.435l41.312,37.677c5.198,4.728,13.215,4.555,18.2-0.422l46.434-46.443c4.967-4.977,5.139-12.984,0.421-18.201l-37.668-41.313c-3.452-3.768-4.412-9.186-2.455-13.914l11.508-27.694c1.937-4.709,6.444-7.874,11.546-8.103l55.851-2.579c7.019-0.318,12.542-6.129,12.542-13.148v-65.699C511.995,216.122,506.472,210.32,499.453,210.004z M256.01,339.618c-46.164,0-83.622-37.438-83.622-83.612c0-46.184,37.458-83.622,83.622-83.622s83.602,37.438,83.602,83.622C339.612,302.179,302.174,339.618,256.01,339.618z"
            fill="currentColor" />
        </svg>
      </button>
    </div>
  </header>

  <!-- ② カレンダーエリア (ビュー切り替え) -->
  <div class="calendar-strip" id="calendarStrip">
    <div class="view-container" id="viewContainer">
      <!-- 週ビュー (Default) -->
      <div id="weekView" class="view-content week-calendar">
        <!-- JS で動的に生成 -->
      </div>
      <!-- 月ビュー -->
      <div id="monthView" class="view-content month-calendar view-hidden"></div>
      <!-- 年ビュー -->
      <div id="yearView" class="view-content year-calendar view-hidden"></div>
    </div>
  </div>

  <div class="date-info-area" id="dateInfoArea">
    <div class="date-info-main" id="dateInfoMain"></div>
    <div class="date-info-sub" id="dateInfoSub" style="display:none;"></div>
  </div>

  <div class="section-divider"></div>

  <!-- 祝日バナー -->
  <div class="holiday-banner" id="holidayBanner" style="display:none;">
    <svg class="holiday-banner-icon" viewBox="0 0 24 24">
      <path d="M12 2L14.09 8.26L21 9.27L16 14.14L17.18 21.02L12 17.77L6.82 21.02L8 14.14L3 9.27L9.91 8.26L12 2Z"
        fill="currentColor" />
    </svg>
    <span id="holidayName"></span>
  </div>

  <!-- ③ タスクエリア -->
  <div class="task-area" id="taskArea">
    <!-- ③-a 時間未定枠 -->
    <div class="unscheduled-section" id="unscheduledSection" style="display:none;">
      <div class="unscheduled-label">時間未定</div>
      <div class="unscheduled-list" id="unscheduledList">
        <!-- JS で動的に生成 -->
      </div>
    </div>

    <!-- ③-b タイムライン -->
    <div class="timeline" id="timeline">
      <!-- JS で動的に生成 -->
    </div>
  </div>

  <!-- ④ フッター -->
  <footer class="footer">
    <button class="someday-btn" id="somedayBtn">
      <svg viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      いつかやる
    </button>
    <button class="add-btn" id="addBtn" aria-label="タスク追加">
      <svg viewBox="0 0 24 24">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    </button>
  </footer>

  <!-- いつかやるボトムシート -->
  <div class="overlay" id="somedayOverlay"></div>
  <div class="bottom-sheet" id="somedaySheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">いつかやる</h2>
      <button class="sheet-close" id="somedayClose" aria-label="閉じる">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="sheet-body" id="somedayList">
      <!-- JS で動的に生成 -->
    </div>
  </div>

  <!-- タスク追加/編集モーダル -->
  <div class="overlay" id="taskOverlay"></div>
  <div class="bottom-sheet task-sheet" id="taskSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header task-header">
      <button class="sheet-close" id="taskSheetClose" aria-label="閉じる">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <h2 class="sheet-title" id="taskSheetTitle">タスク追加</h2>
      <button class="sheet-save" id="taskHeaderSaveBtn" aria-label="保存">
        <svg viewBox="0 0 512 512">
          <polygon fill="currentColor"
            points="440.469,73.413 218.357,295.525 71.531,148.709 0,220.229 146.826,367.055 218.357,438.587 289.878,367.055 512,144.945" />
        </svg>
      </button>
    </div>
    <div class="sheet-body">
      <form id="taskForm" autocomplete="off">
        <input type="hidden" id="taskId" value="">

        <div class="form-group">
          <label for="taskName" class="form-label">タスク名</label>
          <input type="text" id="taskName" class="form-input" placeholder="タスク名を入力" required>
        </div>

        <div class="form-group">
          <label for="taskMemo" class="form-label">メモ</label>
          <textarea id="taskMemo" class="form-input form-textarea" placeholder="メモを入力" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="taskDuration" class="form-label">所要時間</label>
          <select id="taskDuration" class="form-select">
            <option value="5">5分</option>
            <option value="10">10分</option>
            <option value="15">15分</option>
            <option value="30" selected>30分</option>
            <option value="45">45分</option>
            <option value="60">1時間</option>
            <option value="120">2時間</option>
            <option value="180">3時間</option>
            <option value="custom">カスタム</option>
          </select>
        </div>
        <div class="form-group" id="customDurationGroup" style="display:none;">
          <label for="customDuration" class="form-label">カスタム所要時間（分）</label>
          <input type="number" id="customDuration" class="form-input" min="1" max="1440" value="60">
        </div>

        <div class="form-group">
          <label class="form-label">日付</label>
          <div class="form-radio-group">
            <label class="form-radio">
              <input type="radio" name="targetType" value="someday" checked>
              <span>いつかやる</span>
            </label>
            <label class="form-radio">
              <input type="radio" name="targetType" value="goal">
              <span>目標</span>
            </label>
            <label class="form-radio">
              <input type="radio" name="targetType" value="date">
              <span>日付指定</span>
            </label>
          </div>
        </div>

        <div id="goalTargetGroup" style="display:none;">
          <div class="form-group">
            <label for="goalDate" class="form-label">日付設定</label>
            <input type="date" id="goalDate" class="form-input">
          </div>
        </div>

        <div id="dateTargetGroup" style="display:none;">
          <div class="form-group">
            <label for="targetDate" class="form-label">日付設定</label>
            <input type="date" id="targetDate" class="form-input">
          </div>
          <div class="form-group">
            <div class="form-radio-group">
              <label class="form-radio">
                <input type="radio" name="timeType" value="undecided" checked>
                <span>時間未定</span>
              </label>
              <label class="form-radio">
                <input type="radio" name="timeType" value="specified">
                <span>時間指定</span>
              </label>
            </div>
          </div>
          <div class="form-group" id="timeGroup" style="display:none;">
            <label for="targetTime" class="form-label">時刻</label>
            <input type="time" id="targetTime" class="form-input" value="09:00">
          </div>
        </div>


        <div id="taskRecurrenceGroup" class="form-group">
          <label for="taskRecurrence" class="form-label">繰り返し</label>
          <select id="taskRecurrence" class="form-select">
            <option value="none" selected>しない</option>
            <option value="daily">毎日</option>
            <option value="weekly">毎週</option>
            <option value="monthly">毎月</option>
            <option value="yearly">毎年</option>
          </select>

          <!-- 繰り返し詳細設定 -->
          <div id="recurrenceDetails" style="display:none; margin-top: 10px;">

            <!-- 毎日: 除外する曜日 -->
            <div id="recurrenceDaily" class="recurrence-sub" style="display:none;">
              <label class="form-label-sm">除外する曜日</label>
              <div class="day-selector" id="dailyExcludeSelector">
                <label><input type="checkbox" value="0"><span>日</span></label>
                <label><input type="checkbox" value="1"><span>月</span></label>
                <label><input type="checkbox" value="2"><span>火</span></label>
                <label><input type="checkbox" value="3"><span>水</span></label>
                <label><input type="checkbox" value="4"><span>木</span></label>
                <label><input type="checkbox" value="5"><span>金</span></label>
                <label><input type="checkbox" value="6"><span>土</span></label>
              </div>
            </div>

            <!-- 毎週: 実施する曜日 -->
            <div id="recurrenceWeekly" class="recurrence-sub" style="display:none;">
              <label class="form-label-sm">繰り返す曜日</label>
              <div class="day-selector" id="weeklyIncludeSelector">
                <label><input type="checkbox" value="0"><span>日</span></label>
                <label><input type="checkbox" value="1"><span>月</span></label>
                <label><input type="checkbox" value="2"><span>火</span></label>
                <label><input type="checkbox" value="3"><span>水</span></label>
                <label><input type="checkbox" value="4"><span>木</span></label>
                <label><input type="checkbox" value="5"><span>金</span></label>
                <label><input type="checkbox" value="6"><span>土</span></label>
              </div>
            </div>

            <!-- 毎月: 日付は指定日から自動取得 -->
            <div id="recurrenceMonthly" class="recurrence-sub" style="display:none;">
              <div class="text-xs mb-2">※指定した日付で繰り返します</div>
              <div class="avoid-rule-group">
                <label class="form-label-sm">回避する曜日</label>
                <div class="day-selector" id="monthlyAvoidSelector">
                  <label><input type="checkbox" value="0"><span>日</span></label>
                  <label><input type="checkbox" value="1"><span>月</span></label>
                  <label><input type="checkbox" value="2"><span>火</span></label>
                  <label><input type="checkbox" value="3"><span>水</span></label>
                  <label><input type="checkbox" value="4"><span>木</span></label>
                  <label><input type="checkbox" value="5"><span>金</span></label>
                  <label><input type="checkbox" value="6"><span>土</span></label>
                </div>
                <div class="mt-3">
                  <label class="form-label-sm">回避時の動作</label>
                  <select id="monthlyAvoidDir" class="form-select mt-1">
                    <option value="before">前にずらす</option>
                    <option value="after">後にずらす</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- 毎年: 日付は指定日から自動取得 -->
            <div id="recurrenceYearly" class="recurrence-sub" style="display:none;">
              <div class="text-xs mb-2">※指定した日付で繰り返します</div>
              <div class="avoid-rule-group">
                <label class="form-label-sm">回避する曜日</label>
                <div class="day-selector" id="yearlyAvoidSelector">
                  <label><input type="checkbox" value="0"><span>日</span></label>
                  <label><input type="checkbox" value="1"><span>月</span></label>
                  <label><input type="checkbox" value="2"><span>火</span></label>
                  <label><input type="checkbox" value="3"><span>水</span></label>
                  <label><input type="checkbox" value="4"><span>木</span></label>
                  <label><input type="checkbox" value="5"><span>金</span></label>
                  <label><input type="checkbox" value="6"><span>土</span></label>
                </div>
                <div class="mt-3">
                  <label class="form-label-sm">回避時の動作</label>
                  <select id="yearlyAvoidDir" class="form-select mt-1">
                    <option value="before">前にずらす</option>
                    <option value="after">後にずらす</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- 終了日設定 (共通) -->
            <div class="recurrence-sub mt-2">
              <label class="form-label-sm">終了指定</label>
              <div class="form-row align-center">
                <input type="date" id="recurrenceUntil" class="form-input">
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="taskImportance" class="form-label">重要度</label>
          <div class="importance-selector">
            <button type="button" class="importance-btn" data-value="low">低</button>
            <button type="button" class="importance-btn active" data-value="mid">中</button>
            <button type="button" class="importance-btn" data-value="high">高</button>
          </div>


          <div class="form-group form-row" id="taskPinnedRow">
            <label class="form-label">ピン止め</label>
            <label class="toggle">
              <input type="checkbox" id="taskPinned">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-delete" id="taskDeleteBtn" style="display:none;">削除</button>
            <!-- 保存ボタンはヘッダーに移動 -->
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 設定モーダル -->
  <div class="overlay" id="settingsOverlay"></div>
  <div class="bottom-sheet settings-sheet" id="settingsSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">設定</h2>
      <button class="sheet-close" id="settingsClose" aria-label="閉じる">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="sheet-body">
      <div class="settings-section">
        <details class="pwa-accordion">
          <summary class="pwa-accordion-trigger">
            <span class="pwa-accordion-title">ホーム画面への追加方法（PWA）</span>
            <svg class="pwa-accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </summary>
          <div class="pwa-accordion-body">
            <p class="pwa-description">
              本アプリはPWA（Progressive Web App）に対応しており、ホーム画面に追加することで、通常のアプリのようにご利用いただけます。
            </p>

            <h4 class="pwa-sub-heading">Safariでの設定手順（iPhone / iPad）</h4>
            <ol class="pwa-steps-list">
              <li>Safari でアプリのページを開きます</li>
              <li>画面右下の「…」ボタン（その他メニュー）をタップします</li>
              <li>「共有」ボタンをタップします</li>
              <li>メニューを下にスクロールし、<strong>「ホーム画面に追加」</strong>をタップします</li>
              <li>名前を確認し、右上の「追加」をタップすれば完了です</li>
            </ol>
            <p class="pwa-note-inline">
              ホーム画面にアプリアイコンが表示され、次回からはそちらからアクセスできます。
            </p>

            <div class="pwa-warning">
              <div class="pwa-warning-header">
                <svg class="pwa-warning-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                  <line x1="12" y1="9" x2="12" y2="13" />
                  <line x1="12" y1="17" x2="12.01" y2="17" />
                </svg>
                <span>ご利用にあたっての注意事項</span>
              </div>
              <p class="pwa-warning-intro">
                PWAはブラウザの機能を利用してデータを端末内に保存しています。以下の操作や状況により保存データが失われる場合がありますのでご注意ください。
              </p>
              <ul class="pwa-warning-list">
                <li><strong>ブラウザのデータを削除した場合</strong><br>アプリ内に保存されたデータがすべて消去されます。</li>
                <li><strong>端末のストレージ容量が不足している場合</strong><br>OSが自動的にブラウザのデータを削除することがあり、アプリのデータも失われる可能性があります。</li>
                <li><strong>長期間アプリを使用しなかった場合</strong><br>ブラウザの仕様により、一定期間アクセスがないとデータが自動的に削除される場合があります。</li>
                <li><strong>OSやブラウザのアップデート</strong><br>まれに、アップデートの影響でデータが初期化されることがあります。</li>
              </ul>
              <p class="pwa-warning-footer">大切なデータは定期的にバックアップを取ることをおすすめいたします。</p>
            </div>
          </div>
        </details>
      </div>

      <div class="settings-section">
        <h3 class="settings-section-title">外観</h3>
        <div class="settings-item">
          <span class="settings-label">テーマ</span>
          <select id="settingTheme" class="form-select form-select-sm">
            <option value="light">ライト</option>
            <option value="dark">ダーク</option>
          </select>
        </div>
        <div class="settings-item">
          <span class="settings-label">週の始まり</span>
          <select id="settingWeekStart" class="form-select form-select-sm">
            <option value="0">日曜日</option>
            <option value="1">月曜日</option>
          </select>
        </div>
      </div>

      <div class="settings-section">
        <h3 class="settings-section-title">スコア設定</h3>
        <p class="settings-hint">日付未設定の表示順を重要度×残りの日数で計算します。余裕のある日数と迫っている日数を変更すると入れ替わる判定が変わります。</p>
        <div class="settings-item">
          <span class="settings-label">余裕あり判定（○日以上）</span>
          <input type="number" id="settingN1" class="form-input form-input-sm" min="2" max="90" value="8">
        </div>
        <div class="settings-item">
          <span class="settings-label">迫ってる判定（○日以内）</span>
          <input type="number" id="settingN2" class="form-input form-input-sm" min="1" max="89" value="3">
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="js/app.js"></script>
</body>

</html>